<!DOCTYPE html>
<meta charset="utf-8">
<html>
	<head>
		<script src="d3.v3.min.js"></script>
		<script src="/d3-geomap-1.0.1/js/d3.geomap.min.js"></script>
		<script src="d3.geo.projection.min.js"></script>
		<script src="topojson.v1.min.js"></script>
		<script src="d3-queue.v2.min.js"></script>
		<style>
			body{
				background-color:#0099ff;
			}
			.button1{
				font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif;
				background-color:#0099ff;
				color: white;
				border: 5px solid white;
				border-radius: 8px;
				padding: 10px 30px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 20px;
				line-height: 150%;
				margin: 5px;
				width: 125px;
			}
			.button1:hover{
				background-color:white;
				color: #0099ff;
				border: none;
			}
			.button2{
				font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif;
				background-color:#0099ff;
				color: white;
				border: 5px solid white;
				border-radius: 8px;
				padding: 10px 10px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 20px;
				line-height: 150%;
				margin: 5px;
				width: 200px;
			}
			.button2:hover{
				background-color:white;
				color: #0099ff;
				border: none;
			}
			#svg {
				background-color:#0099ff;
				width: 1500px;
				height: 1000px;
				float:left;
				padding:5px; 
			}
			.q0-9 { fill:rgb(230, 255, 153); fill-opacity:1.0;}
			.q1-9 { fill:rgb(196, 255, 77);  fill-opacity:1.0;}
			.q2-9 { fill:rgb(172, 250, 0);  fill-opacity:1.0;}
			.q3-9 { fill:rgb(100, 210, 0 );  fill-opacity:1.0;}
			.q4-9 { fill:rgb(60, 180, 0);  fill-opacity:1.0;}
			.q5-9 { fill:rgb(45, 150, 0);  fill-opacity:1.0;}
			.q6-9 { fill:rgb(10, 100, 0);  fill-opacity:1.0;}
			.q7-9 { fill:rgb(0, 60, 0);  fill-opacity:1.0;}
			.q8-9 { fill:rgb(0, 30, 0);  fill-opacity:1.0;}
			.hovered{
				fill-opacity:1;
				fill: #ff9900;
				stroke: white;
				stroke-width:2px;
			}
			.textdec{
				font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif;
				background-color:#0099ff;
				color: white;
				padding: 10px 30px;
				text-decoration: none;
				font-size: 25px;
				line-height: 150%;
			}
		</style>
	</head>
	<body>
		<div id = "buttons" style="width:100%;height: 80px; float:center;">
		<center>
			<button class="button1" id="b2006">2006</button>
			<button class="button1" id="b2007">2007</button>
			<button class="button1" id="b2008">2008</button>
			<button class="button1" id="b2009">2009</button>
			<button class="button1" id="b2010">2010</button>
			<button class="button1" id="b2011">2011</button>
		</center>
		</div>
		<div id="themap" style="width:85%;height: 1000px; float:left; min-width:1500px;"></div>
		<div id="controls" style="width:12%;height: 500px; float:right;">
		<br><br><br>
		<br><br><br>
			<input class="button2" type="button" value="Hide CO2 Data!" id="co2"></input> 
			<br><br><br>
			<input class="button2" type="button" value="Max CO2 Data!" id="mxco2data"></input> 
			<input class="button2" type="button" value="Min CO2 Data!" id="mnco2data"></input> 
			<input class="button2" type="button" value="Max Forest Data!" id="mxfordata"></input> 
			<input class="button2" type="button" value="Min Forest Data!" id="mnfordata"></input> 
		</div>
		<div id="info" style="width:12%;height: 500px; float:right;">
		<p id="infotext" class="textdec"></p>
		</div>
		<script>
			var shData = 1, chYear = 1, maxco2 = 0, maxfor = 0, minco2 = 0, minfor = 0;
			var maxco2on = 0, minco2on = 0, maxforon = 0, minforon = 0;
			showMap(1);
			b2006.onclick = function() {
				showMap(1); chYear=1;
				cleardata();
			};
			b2007.onclick = function() {
				showMap(2); chYear=2;
				cleardata();
			};
			b2008.onclick = function() {
				showMap(3); chYear=3;
				cleardata();
			};
			b2009.onclick = function() {
				showMap(4); chYear=4;
				cleardata();
			};
			b2010.onclick = function() {
				showMap(5); chYear=5;
				cleardata();
			};
			b2011.onclick = function() {
				showMap(6); chYear=6;
				cleardata();
			};
			co2.onclick = function(){
			var elem = document.getElementById("co2");
				if(shData==1){
					shData = 0;
					elem.value = "Show CO2 Data!";
				}
				else {
					shData = 1;
					elem.value = "Hide CO2 Data!";
				}
				cleardata();
				showMap(chYear);
			}
			function cleardata(){
				maxco2 = 0; maxfor = 0; minco2 = 0; minfor = 0;
				maxco2on = 0; minco2on = 0; maxforon = 0; minforon = 0;
				document.getElementById('infotext').innerHTML = "";
			}
			var svg = d3.select("body").select("#themap").append("svg").attr("id","svg");
			function showMap(year){

				var width = 1500,
				height = 1000, centered;
				var projection = d3.geo.naturalEarth().scale(300)
									.translate([width / 2, height / 2]).precision(0.1);
				var path = d3.geo.path().projection(projection);
				var rateById1 = d3.map();
				var rateById2 = d3.map();
				d3_queue.queue()
						.defer(d3.json, "/d3-geomap-1.0.1/topojson/world/countries.json")
						.defer(d3.csv, "/ExtractedWorldData.csv", 
						function(d) { 
							if(year==1) {
								rateById1.set(d.CountryCode, +d.CO2YR2006); 
								rateById2.set(d.CountryCode, +d.FAYR2006); 
								}
							else if(year==2) {
								rateById1.set(d.CountryCode, +d.CO2YR2007); 
								rateById2.set(d.CountryCode, +d.FAYR2007); 
								}
							else if(year==3) {
								rateById1.set(d.CountryCode, +d.CO2YR2008); 
								rateById2.set(d.CountryCode, +d.FAYR2008); 
								}
							else if(year==4) {
								rateById1.set(d.CountryCode, +d.CO2YR2009); 
								rateById2.set(d.CountryCode, +d.FAYR2009); 
								}
							else if(year==5) {
								rateById1.set(d.CountryCode, +d.CO2YR2010); 
								rateById2.set(d.CountryCode, +d.FAYR2010); 
								}
							else if(year==6) {
								rateById1.set(d.CountryCode, +d.CO2YR2011);
								rateById2.set(d.CountryCode, +d.FAYR2011);
								}								
						})
						.await(ready);
				var quantize = d3.scale.pow().exponent(0.8)
									.domain([0, 6000])
									.range(d3.range(9).map(function(i){return i;}));
				function radius(r){
					if(typeof r == 'undefined') return 0;
					return d3.round(r);
				}
				function ready(error, countries) {
					if (error) throw error;
					var datac = [], dataf = [];
					svg.selectAll("g").remove();
					svg.append("g").attr("fill","#696969").attr("fill-opacity", "0.7")
								.attr("class", "units zoom")
								.selectAll("path")
								.data(topojson.feature(countries, countries.objects.units).features)
								.enter().append("path").attr("id", function(d){ return d.id; })
								.attr("class", function(d) { datac.push(d); return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; })
								.attr("d", path).on("click",function(d) { clicked(d,"#"+d.id);}).on("mouseover", hovered).on("mouseout",nohovered);
					svg.append("g")
								.attr("class", "units zoom")
								.selectAll("circle")
								.data(topojson.feature(countries, countries.objects.units).features)
								.enter().append("circle").attr("fill-opacity", ".4")
								.attr("transform", function(d) {  dataf.push(d); return "translate(" + path.centroid(d) + ")"; })
								.attr("r", function(d){ 
													if(shData==1)
														return radius(rateById1.get(d.id));
													else
														return 0;
													})
								.attr("fill","#990000").on("click",function(d) { clicked(d,"#"+d.id);});
					for (var i in datac) { 
						if(datac[i].id=="QAT") {
							maxco2 = datac[i];
						}
						if(datac[i].id=="BDI") {
							minco2 = datac[i];
						}
					}
					for (var i in dataf) { 
						if(dataf[i].id=="RUS") {
							maxfor = dataf[i];
						}
						if(dataf[i].id=="QAT") {
							minfor = dataf[i];
						}
					}
					mxco2data.onclick = function() { 
						if(minco2on == 1) svg.select("#"+minco2.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(minforon == 1) svg.select("#"+minfor.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(maxforon == 1) svg.select("#"+maxfor.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						clicked(maxco2,"#"+maxco2.id); 
						if(centered!= null && centered.id == maxco2.id){
							document.getElementById('infotext').innerHTML = maxco2.properties.name + " has maximum CO2 emission of " + rateById1.get(maxco2.id) +
							" metric tons per capita.";
							maxco2on =1;
						}
						else {
							maxco2on = 0;
							document.getElementById('infotext').innerHTML = "";
						}
					}
					mnco2data.onclick = function() { 
						if(maxco2on == 1) svg.select("#"+maxco2.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(minforon == 1) svg.select("#"+minfor.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(maxforon == 1) svg.select("#"+maxfor.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						clicked(minco2,"#"+minco2.id); 
						if(centered!= null && centered.id == minco2.id){
							document.getElementById('infotext').innerHTML = minco2.properties.name + " has minimum CO2 emission of " + rateById1.get(minco2.id) +
							" metric tons per capita.";
							minco2on =1;
						}
						else {
							minco2on = 0;
							document.getElementById('infotext').innerHTML = "";
						}
					}
					mxfordata.onclick = function() { 
						if(minco2on == 1) svg.select("#"+minco2.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(minforon == 1) svg.select("#"+minfor.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(maxco2on == 1) svg.select("#"+maxco2.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						clicked(maxfor,"#"+maxfor.id); 
						if(centered!= null && centered.id == maxfor.id){
							document.getElementById('infotext').innerHTML = maxfor.properties.name + " has maximum forest area of " + rateById2.get(maxfor.id) +
							" square kilometers.";
							maxforon =1;
						}
						else {
							maxforon = 0;
							document.getElementById('infotext').innerHTML = "";
						}
					}
					mnfordata.onclick = function() {
						if(minco2on == 1) svg.select("#"+minco2.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(maxco2on == 1) svg.select("#"+maxco2.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						if(maxforon == 1) svg.select("#"+maxfor.id).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });					
						clicked(minfor,"#"+minfor.id); 
						if(centered!= null && centered.id == minfor.id){
							document.getElementById('infotext').innerHTML = minfor.properties.name + " has minimum forest area of " + rateById2.get(minfor.id) +
							" square kilometers.";
							minforon =1;
						}
						else {
							minforon = 0;
							document.getElementById('infotext').innerHTML = "";								
						}
					}
				}

				function hovered(d){
					d3.select(this).attr("class", "hovered");
					d3.select(this).append("svg:title")
						.text(d.properties.name+"\nCO2 Emissions: "+rateById1.get(d.id)+" (metric tons per capita)"
								+"\nForest Area: "+rateById2.get(d.id)+" (sq. km)").style("visibility", "visible") ;
				}
				function nohovered(d){
					d3.select(this).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
				}
				function clicked(d, code) {
					var x, y, k;
					if (d && centered !== d) {
						var centroid = path.centroid(d);
						x = centroid[0];
						y = centroid[1];
						k = 4;
						centered = d;
						transp = 0;
						durat = 100;
						console.log(code);
						svg.select(code).attr("class", "hovered");
					} else {
						x = width / 2;
						y = height / 2;
						k = 1;
						centered = null;
						transp = 0.4;
						durat = 1500;
						svg.select(code).attr("class", function(d) { return "q"+d3.round(quantize(rateById2.get(d.id)/100))+"-9"; });
						maxco2on = 0; minco2on = 0; maxforon = 0; minforon = 0;
					}
					svg.select("g").selectAll("path")
						.classed("active", centered && function(d) { return d === centered; });
					svg.select("g").transition()
						.duration(750)
						.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
						.style("stroke-width", 1.5 / k + "px");
					svg.selectAll("circle").transition()
						.duration(durat)
						.attr("fill-opacity", transp);
				}
				d3.select(self.frameElement).style("height", height + "px");		

			}
		</script>
	</body>
</html>